# Licensed to Elasticsearch B.V. under one or more contributor
# license agreements. See the NOTICE file distributed with
# this work for additional information regarding copyright
# ownership. Elasticsearch B.V. licenses this file to you under
# the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations

IMAGE ?= integrations/test-reporter
VERSION ?= latest
VENV ?= ./venv
PYTHON ?= python3

.PHONY: help
.DEFAULT_GOAL := help

help: ## Display this help text
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

all: build test

build: ## Build docker image
	@docker build --file Dockerfile --tag=${IMAGE}:${VERSION} .

bats: ## Install bats in the project itself
	@git clone https://github.com/sstephenson/bats.git .bats/

venv: requirements-dev.txt
	test -d $(VENV) || virtualenv -q --python=$(PYTHON) $(VENV);\
	. $(VENV)/bin/activate || exit 1;\
	pip install -r requirements-dev.txt;\
	touch $(VENV);\

test: venv ## Run the tests
	@echo "Tests are in progress, please be patient"
	@.bats/bin/bats tests.bats
	@PYTHONPATH=. $(VENV)/bin/pytest

clean: ## Clean autogenerated files/folders
	@rm -rf .bats/